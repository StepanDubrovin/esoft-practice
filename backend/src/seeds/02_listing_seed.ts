import { Knex } from "knex";
import { v7 as uuidv7 } from 'uuid';

export async function seed(knex: Knex): Promise<void> {
  // Deletes ALL existing entries
  await knex('listings').del();

  const users = await knex('users').select('id');

  const getUserId = (() => {
    const usageMap = new Map<string, number>();
    return () => {
      for (const user of users) {
        const count = usageMap.get(user.id) || 0;
        if (count < 2) {
          usageMap.set(user.id, count + 1);
          return user.id;
        }
      }
    };
  })();

  const listings = [
  {
    title: 'Современная студия в центре',
    description: 'Идеально подходит для одного человека или пары. Стильный интерьер, новая мебель, оборудованная кухня. Рядом метро, магазины, кафе и фитнес-клуб. Без животных.',
    price: 45000,
    type: 1,
    city: 'Москва',
  },
  {
    title: 'Квартира с видом на Неву',
    description: 'Просторная и светлая 3-комнатная квартира с видом на набережную. Качественная отделка, тёплые полы, большая кухня-гостиная. Рядом парки, музеи и рестораны.',
    price: 12000000,
    type: 2,
    city: 'Санкт-Петербург',
  },
  {
    title: 'Дом у озера',
    description: 'Уютный дом в живописном месте. Просторный участок 10 соток, баня, беседка, зона барбекю. Внутри 4 спальни, гостиная с камином, кухня, сауна. Отличный подъезд круглый год.',
    price: 23000000,
    type: 2,
    city: 'Тюмень',
  },
  {
    title: 'Сдаётся однушка в Академгородке',
    description: 'Уютная и светлая квартира рядом с университетом и технопарком. Вся мебель и техника, интернет включён. Рядом остановки, магазины, зелёная зона.',
    price: 30000,
    type: 1,
    city: 'Новосибирск',
  },
  {
    title: 'Таунхаус в пригороде',
    description: 'Современный таунхаус 150 кв.м с гаражом и террасой. Три спальни, два санузла, кухня-столовая. Тихий район, свежий воздух, рядом лес и река. Асфальт до дома.',
    price: 17000000,
    type: 2,
    city: 'Екатеринбург',
  },
  {
    title: 'Квартира бизнес-класса',
    description: '2-комнатная квартира с дизайнерским ремонтом. Панорамные окна, тёплые полы, система "умный дом". Закрытый двор с охраной и видеонаблюдением. Подземный паркинг.',
    price: 85000,
    type: 1,
    city: 'Москва',
  },
  {
    title: 'Студия у метро Петроградская',
    description: 'Комфортная студия, полностью меблирована. Современная бытовая техника, быстрый Wi-Fi. 2 минуты до метро, рядом продуктовые магазины и кофейни.',
    price: 40000,
    type: 1,
    city: 'Санкт-Петербург',
  },
  {
    title: 'Дом с земельным участком',
    description: 'Кирпичный дом 120 кв.м на участке 15 соток. Плодовые деревья, баня, гараж. Просторная кухня-гостиная, тёплый пол, хорошая вода из скважины. До центра 15 минут.',
    price: 9800000,
    type: 2,
    city: 'Сургут',
  },
  {
    title: '2-комнатная в центре Тюмени',
    description: 'Светлая квартира с новым ремонтом. Вся техника: холодильник, стиралка, посудомойка. Балкон, гардеробная. До парка 5 минут, остановки и магазины рядом.',
    price: 55000,
    type: 1,
    city: 'Тюмень',
  },
  {
    title: 'Дом с панорамными окнами',
    description: 'Современный дом в стиле хай-тек. 2 этажа, гостиная с камином, терасса, мастер-спальня с ванной. Участок 12 соток, автоматические ворота. Рядом лес и озеро.',
    price: 21500000,
    type: 2,
    city: 'Екатеринбург',
  },
  {
    title: 'Сдаётся студия у НГТУ',
    description: 'Уютная студия после ремонта. Новая мебель, шкаф-купе, рабочее место, интернет. Закрытая территория, домофон. До университета — 10 минут пешком.',
    price: 28000,
    type: 1,
    city: 'Новосибирск',
  },
  {
    title: 'Продаётся коттедж',
    description: 'Элитный коттедж в престижном районе. 3 этажа, 6 спален, бассейн, сауна, камин, зимний сад. Гараж на 2 машины. Участок с ландшафтным дизайном и системой полива.',
    price: 33000000,
    type: 2,
    city: 'Москва',
  },
  {
    title: 'Светлая квартира в новостройке',
    description: '2-комнатная квартира в новом доме. Большая кухня, застеклённый балкон, окна во двор. Во дворе детская площадка, рядом школа, ТЦ, аптека. Свежий ремонт.',
    price: 60000,
    type: 1,
    city: 'Санкт-Петербург',
  },
  {
    title: 'Дом в коттеджном посёлке',
    description: '2-этажный дом с современным ремонтом. Закрытая охраняемая территория, своя школа и магазины. Тёплый гараж, кладовая, бойлерная. Транспорт ходит регулярно.',
    price: 19500000,
    type: 2,
    city: 'Сургут',
  },
  {
    title: '1-комнатная в центре Екб',
    description: 'Стильная квартира для аренды. Современная мебель, кондиционер, стиральная машина, быстрый Wi-Fi. Пешая доступность до метро, кафе, офисов.',
    price: 37000,
    type: 1,
    city: 'Екатеринбург',
  }
];


  // Inserts seed entries
  const fullListings = listings.map(listing => ({
    id: uuidv7(),
    title: listing.title,
    description: listing.description,
    price: listing.price,
    type: listing.type,
    city: listing.city,
    status: 1,
    createdAt: knex.fn.now(),
    updatedAt: knex.fn.now(),
    creatorId: getUserId()
  }));

  await knex('listings').insert(fullListings);
}
